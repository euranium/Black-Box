#!/bin/bash
# set up the db, build the go project, check if succesfull
# if success, mv executable to an .o file for .gitinore
# then run
# make dir users for user folder, not tracked by git
# make dir aaa for testing stuff in

clear
clean=1
tst=1
port="-port=8080"
while getopts ":ctp:" o; do
    case $o in
        c)
			clean=0
            ;;
        t)
			tst=0
            ;;
		p)
			port="-port=$OPTARG"
			;;
        "?")
			echo unknown argument
			exit 1
            ;;
    esac
done
shift "$((OPTIND-1))"

#echo $clean $tst
if [ $clean -eq 0 ]; then
	echo clearing dabase and files
	rm "data.db"
	rm -rf "users/aaa"
fi

if [ ! -e "data.db" ]; then
	sqlite3 data.db < data.sql
fi

if [ ! -d "users/aaa" ]; then
	mkdir -p "users/aaa"
fi

go build
if [ $? -eq 0 ]; then
	fld=${PWD##*/}
	if [ -f $fld ]; then
		mv $fld ${fld}.o
		if [ $tst -eq 0 ]; then
			echo 'sucess'
		else
			./${fld}.o $port
		fi
	fi
else
	echo 'error'
	exit $?
fi
